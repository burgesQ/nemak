#+TITLE: nemacs's config (2)
#+AUTHOR: Quentin Burgess (quentin.burgess@frafos.com)
#+DESCRIPTION: Quick summary of tasks for nemacs second gen
#+STARTUP: show2levels
#+OPTIONS: toc:2

Thanks

- [[https://github.com/progfolio/.emacs.d/tree/master][nice helper]]
- [[https://github.com/syl20bnr/spacemacs][spcemacs]] of course
- [[https://github.com/doomemacs/doomemacs][doomecas]] also
- stackoverflow
- DT' youtube videos
- [[https://ianyepan.github.io/posts/emacs-emojis/][nice tuto about emojis]]
- [[https://github.com/mickeynp/ligature.el/wiki#cascadia--fira-code][ligatures official doc]]
- [[https://www.rahuljuliato.com/posts/emacs-tab-bar-groups][better native tab-bar]]
- [[https://howardabrams.com/hamacs/][monster config]]
- [[https://github.com/jeremygooch/jeremacs][less monstruous but still huge]]



* TODO how to use [0/3]

TODO: intro + usage
To test the configuration, run

#+begin_example console
$ emacs -q -l ~/repo/perso/nemacs/emacs-init.el --init-directory=~/repo/perso/nemacs
#+end_example

** TODO install as ~/.emacs
** TODO as systemctl service (aka emacsclient)
** TODO misc
chemacs


* TODO TODOs
** TODO v1 [2/8] [25%]
*** DONE early init
*** DONE elpa management
*** TODO keybinding
*** TODO key describe (helpful)
*** TODO claude-el
*** TODO UI [1/2]
**** WIP dashboard
**** DONE fonts / faces / emojies / ligatures
**** other stuffs (windows, box)
*** TODO utils
*** TODO LSP

*** doc (how to use chapter)


* the config

** early-init

emacs 27+ offer the ealy-init, allowing us to speed thing up at start time.

*** header

`early-init.el` header

#+begin_src emacs-lisp
;;; early-init.el --- Early Init File -*- lexical-binding: t; no-byte-compile: t -*-
;;; Code:
#+end_src

*** elpaca tweaks

Since we're using elpaca as our package manager, we add the following to early-init.el to prevent package.el from loading packages, prior to our init file loading.


#+BEGIN_SRC emacs-lisp
;; Do not attempt to load default package manager.
(setq package-enable-at-startup nil)
#+END_SRC

We configure elpaca to download packages per emacs version

#+BEGIN_SRC emacs-lisp
;; elpa dir per emacs version
(setq package-user-dir (locate-user-emacs-file
                        (concat
                         (file-name-as-directory "elpa")
                         emacs-version)))
#+END_SRC

*** speed things up

#+BEGIN_SRC emacs-lisp
;; Skip default.el loading.
(setq inhibit-default-init nil)
;; Report native comp async warnings as errors.
(setq native-comp-async-report-warnings-errors nil)
#+END_SRC

Skipping a bunch of regular expression searching in the file-name-handler-alist should improve start time.

#+begin_src emacs-lisp
;; skipping bunch of regex at start time
(defvar default-file-name-handler-alist
  file-name-handler-alist)
(setq file-name-handler-alist nil)
#+end_src

*** debug

Running this form will launch the debugger after loading a package.
This is useful for finding out when a dependency is requiring a package
(perhaps earlier than you want).
Use by tangling this block and launching Emacs with emacs --debug-init.

#+begin_src emacs-lisp
;; (unless (string-empty-p file)
;;   (eval-after-load file
;;     '(debug)))
#+end_src

Similarly, this variable will hit the debugger when a message matches its regexp.

#+begin_src emacs-lisp
;; (setq debug-on-message "")
#+end_src

Adding a variable watcher can be a useful way to track down initialization and mutation of a variable.

#+begin_src emacs-lisp
;; (add-variable-watcher 'org-capture-after-finalize-hook
;;                       (lambda (symbol newval operation where)
;;                         (debug)
;;                         (message "%s set to %s" symbol newval)))

;; (setq debug-on-error t)
#+end_src

*** gbc tweak

`gc-cons-threshold` (800 KB) and `gc-cons-percentage` (0.1) control when the Emacs garbage collector can kick in. Temporarily turning these off during init should decrease startup time. Resetting them afterward will ensure that normal  operations don’t suffer from a large GC periods.

The following is a table shows values from popular Emacs configurations.

| Distribution | gc-cons-threshold |
|--------------+-------------------|
| Doom         |          16777216 |
| Spacemacs    |         100000000 |
| Default      |            800000 |

#+BEGIN_SRC emacs-lisp
;; tmp disable GC for startup, then re-activating it
(setq gc-cons-threshold most-positive-fixnum
      gc-cons-percentage 1)

(defun +nemacs/gc-after-focus-change ()
  "Run GC when frame loses focus."
  (run-with-idle-timer
   5 nil
   (lambda () (unless (frame-focus-state) (garbage-collect)))))
#+END_SRC

#+BEGIN_SRC emacs-lisp
(defun +nemacs/better-init-values ()
  "Set GC value to some sensitive one."
  (run-with-idle-timer
   1 nil
   (lambda ()
     (setq file-name-handler-alist default-file-name-handler-alist
           gc-cons-threshold 50000000
           read-process-output-max (* 1024 1024)
           gc-cons-percentage 0.2)
     (message "gc-cons-threshold & file-name-handler-alist restored")
     (when (boundp 'after-focus-change-function)
       (add-function :after after-focus-change-function #'+nemacs/gc-after-focus-change))
     )))

;; enable gbc msg
(setq garbage-collection-messages t)

(add-hook 'emacs-startup-hook #'+nemacs/better-init-values)
#+END_SRC

*** UI tweaks

Modify GUI elements before we have a chance to peek.


Turning off these visual elements before UI initialization should speed up init.

#+BEGIN_SRC emacs-lisp
;; disables menubar
(push '(menu-bar-lines . 0) default-frame-alist)
;; disables toolbar
(push '(tool-bar-lines . 0) default-frame-alist)
;; disables vertical scrollbar
(push '(vertical-scroll-bars) default-frame-alist)
#+END_SRC

Prevent instructions on how to close an emacsclient frame.

#+BEGIN_SRC emacs-lisp
(setq server-client-instructions nil)
#+END_SRC

Implicitly resizing the Emacs frame adds to init time. Fonts larger than the system default can cause frame resizing, which adds to startup tim.e

#+BEGIN_SRC emacs-lisp
(setq frame-inhibit-implied-resize t)
#+END_SRC

Ignore X resources.

#+BEGIN_SRC emacs-lisp
(advice-add #'x-apply-session-resources :override #'ignore)
#+END_SRC

Silence ring bell.

#+BEGIN_SRC emacs-lisp
(setq ring-bell-function #'ignore)
#+END_SRC

Lets tune the UI to something more minimal.

#+BEGIN_SRC emacs-lisp
;; enable smooth scrolling
(pixel-scroll-precision-mode 1)
;; disables menubar
(menu-bar-mode -1)
;; disables toolbar
(tool-bar-mode -1)
;; disables scrollbar
(scroll-bar-mode -1)

(setq
 ;; no thanks
 inhibit-splash-screen t
 ;; don't use system file dialog
 use-file-dialog nil
 ;; don't show new tab button
 tab-bar-new-button-show nil
 ;; don't show tab close button
 tab-bar-close-button-show nil
 ;; don't show tab close button
 tab-line-close-button-show nil)
#+END_SRC

Let's tune the system windows.

#+BEGIN_SRC emacs-lisp
;; undecorate windows
;; this should be called before toggle-frame-maximized
(set-frame-parameter nil 'undecorated t)
(set-frame-parameter nil 'internal-border-width 0)
(add-to-list 'default-frame-alist '(undecorated . t))
(add-to-list 'default-frame-alist '(internal-border-width . 0))
#+END_SRC

Set a few fonts.

#+BEGIN_SRC emacs-lisp
;; Set fonts.
(push '(font . "Fira Code Retina") default-frame-alist)
(set-face-font 'default "Fira Code Retina")
(set-face-font 'variable-pitch "Fira Code Retina")
(copy-face 'default 'fixed-pitch)
;; NOTE: needed for emacsclient - fix reduced font size
(add-to-list 'default-frame-alist '(font . "Fira Code Retina"))
#+END_SRC

And start as a maximized window.

Taken from this [[https://emacsredux.com/blog/2020/12/04/maximize-the-emacs-frame-on-startup/][essay]], I figured I would start the initial frame automatically in fullscreen, but not any subsequent frames (as this could be part of the capturing system).

#+BEGIN_SRC emacs-lisp
;; Start as maximized window. (old implem)
;; (unless (frame-parameter nil 'fullscreen)
;;   (toggle-frame-maximized))
;; (add-to-list 'default-frame-alist '(fullscreen . maximized))


(add-to-list 'initial-frame-alist '(fullscreen . maximized))

#+END_SRC

But when capturing, I subsequently open smaller frames that shouldn’t be odd looking:

#+begin_src emacs-lisp
(add-to-list 'default-frame-alist '(ns-transparent-titlebar . t))
(add-to-list 'default-frame-alist '(ns-appearance . dark))
(add-to-list 'default-frame-alist '(undecorated-round . t))
#+end_src

*** let's "provide" the early init

#+BEGIN_SRC emacs-lisp
(provide 'early-init)
;;; early-init.el ends here
#+END_SRC


** config

*** init.el header

#+begin_src emacs-lisp
;;; init.el --- Personal configuration file -*- lexical-binding: t; no-byte-compile: t; -*-
;; NOTE: init.el is generated from init.org.  Please edit that file instead
#+end_src

*** package manager
**** elpaca

Let's install elpaca.
See the [[https://github.com/progfolio/elpaca#installer][repo instructions]] for more.

#+begin_src emacs-lisp
;;
;; Package manager (elpaca)
;;

(defvar elpaca-installer-version 0.11)
(defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
(defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
(defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
(defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                              :ref nil :depth 1 :inherit ignore
                              :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                              :build (:not elpaca--activate-package)))
(let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
       (build (expand-file-name "elpaca/" elpaca-builds-directory))
       (order (cdr elpaca-order))
       (default-directory repo))
  (add-to-list 'load-path (if (file-exists-p build) build repo))
  (unless (file-exists-p repo)
    (make-directory repo t)
    (when (<= emacs-major-version 28) (require 'subr-x))
    (condition-case-unless-debug err
        (if-let* ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                  ((zerop (apply #'call-process `("git" nil ,buffer t "clone"
                                                  ,@(when-let* ((depth (plist-get order :depth)))
                                                      (list (format "--depth=%d" depth) "--no-single-branch"))
                                                  ,(plist-get order :repo) ,repo))))
                  ((zerop (call-process "git" nil buffer t "checkout"
                                        (or (plist-get order :ref) "--"))))
                  (emacs (concat invocation-directory invocation-name))
                  ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                        "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                  ((require 'elpaca))
                  ((elpaca-generate-autoloads "elpaca" repo)))
            (progn (message "%s" (buffer-string)) (kill-buffer buffer))
          (error "%s" (with-current-buffer buffer (buffer-string))))
      ((error) (warn "%s" err) (delete-directory repo 'recursive))))
  (unless (require 'elpaca-autoloads nil t)
    (require 'elpaca)
    (elpaca-generate-autoloads "elpaca" repo)
    (let ((load-source-file-function nil)) (load "./elpaca-autoloads"))))
(add-hook 'after-init-hook #'elpaca-process-queues)
(elpaca `(,@elpaca-order))
#+end_src

Let's also setup the ``use-package`` macro.

#+begin_src emacs-lisp
;; Install a package via the elpaca macro
;; See the "recipes" section of the manual for more details.

;; (elpaca example-package)

;; Install use-package support
(elpaca elpaca-use-package
  ;; Enable use-package :ensure support for Elpaca.
  (elpaca-use-package-mode))

;; Set default ``:ensure`` to `(:wait t)
;; (setq use-package-always-ensure t)

;;When installing a package used in the init file itself,
;;e.g. a package which adds a use-package key word,
;;use the :wait recipe keyword to block until that package is installed/configured.
;;For example:
;;(use-package general :ensure (:wait t) :demand t)

;;Turns off elpaca-use-package-mode current declaration
;;Note this will cause evaluate the declaration immediately. It is not deferred.
;;Useful for configuring built-in emacs features.
;; (use-package emacs
;;   :ensure nil
;;   :config (setq ring-bell-function #'ignore))


;; NOTE: current config tell elpaca to load package **after** emacs init.
;; the following will "lazy-load" a package installation
;; (use-package s :ensure (:wait t))
;; will  adding :demand t will enfore it's installation

(setq custom-file (expand-file-name "init.el" user-emacs-directory))
(add-hook 'elpaca-after-init-hook (lambda () (load custom-file 'noerror)))
#+end_src





*** TODO emacs defaults

#+begin_src emacs-lisp
;;Note this will cause evaluate the declaration immediately. It is not deferred.
;;Useful for configuring built-in emacs features.
(use-package emacs
  :ensure nil
  :demand t
  :config
  ;;Turns off elpaca-use-package-mode current declaration
  (setq ring-bell-function #'ignore)
)
#+end_src

**** org

*** keybinding

**** general

Better key-bindings management.
See the [[https://github.com/noctuid/general.el][repo]] for more info.

#+begin_src emacs-lisp
;;
;; Key-Bindings
;;

;; Install general to manage keybinding.
(use-package general
  :ensure(:wait t)
  :demand t
  :config
  (general-auto-unbind-keys)

  ;; Setup M-m as the global leader key.
  (general-create-definer nemacs/leader-keys
    :state '(normal inset visual emacs)
    :keymap 'override
    :prefix "M-m" ;; Set leader.
    :global-prefix "M-m") ;; Access leader in insert mode.

  (nemacs/leader-keys
    "b" '(:ignore t :wk "Buffer")
    "b d"  '(kill-current-buffer :wk "Kill current buffer")
    "b b" '(switch-to-buffer :wk "Switch buffer")
    "b i" '(ibuffer :wk "Ibuffer")
    "b k" '(kill-this-buffer :wk "Kill this buffer")
    "b M" '((lambda () (interactive) (switch-to-buffer "*Messages*"))
            :wk "Messages buffer")
    "b n" '(next-buffer :wk "Next buffer")
    "b p" '(previous-buffer :wk "Previous buffer")
    "b r" '(revert-buffer :wk "Reload buffer")
    "b s"  '(scratch-buffer :wk "Scratch buffer"))

  (nemacs/leader-keys
    "c" '(:ignore t :wk "Config")
    "c r" '((lambda () (interactive)
	      (elpaca-process-queues)
              (elpaca-wait)
	      (load-file "~/repo/perso/nemacs_2/emacs-init.el"))
	    ;; another option: "c r" '(restart-emacs :wk "Restart Emacs") + (use-package restart-emacs  :ensure t)
            :wk "Reload emacs config")
    "c o" '((lambda () (interactive) (find-file "~/repo/perso/nemacs_2/init.org"))
            :wk "Open emacs config"))

  ;; (nemacs/leader-keys
  ;;   "E" '(:ignore t :wk "Error")
  ;;   "E b" '((lambda () (interactive) (setq compilations-scroll-output t)) :wk "Errror buffer to bottom")
  ;;   "E f" '((lambda () (interactive) (setq compilations-scroll-output 'first-error)) :wk "Errror buffer first error")
  ;;   "E l" '(flycheck-list-errors :wk "List flycheck error")
  ;;   "E t" '(lsp-treemacs-errors-list :wk "List error tree"))

  (nemacs/leader-keys
   "E" '(:ignore t :wk "Evaluate")
   "E b" '(eval-buffer :wk "Evaluate elisp in buffer")
   "E d" '(eval-defun :wk "Evaluate defun containing or after point")
   "E e" '(eval-expression :wk "Evaluate and elisp expression")
   "E l" '(eval-last-sexp :wk "Evaluate elisp expression before point")
   "E r" '(eval-region :wk "Evaluate elisp in region"))

  (nemacs/leader-keys
    "g" '(:ignore t :wk "Git")
  ;;  "g b"  '(magit-branch :wk "Git branch")
  ;;  "g B"  '(magit-blame  :wk "Git blame")
  ;;  "g c"  '(magit-clone    :wk "Git clone")
  ;;  "g f"  '(:ignore t :which-key "Git file")
  ;;  "g ff" '(magit-find-file :wk "Git find file")
  ;;  "g fh" '(magit-log-buffer-file :wk "Git log buffer fule")
  ;;  "g i"  '(magit-init :wk "Git init")
  ;;  "g L"  '(magit-list-repositories :wk "Git list repositories")
  ;;  "g m"  '(magit-dispatch :wk "Git dispatch")
  ;;  "g S"  '(magit-stage-file :wk "Git stage file")
  ;;  "g s"  '(magit-status :wk "Git status")
  ;;  "g U"  '(magit-unstage-file :wk "Git unstage file")
    )

  (nemacs/leader-keys
   "h" '(:ignore t :wk "Help")
   "h f" '(describe-function :wk "Describe function")
   "h v" '(describe-variable :wk "Describe variable"))

  ;; lsp
  (nemacs/leader-keys
    "l" '(:ignore t :wk "LSP"))

  ;; Major mode
  (nemacs/leader-keys
    "m" '(:ignore t :wk "Major mode"))

  (nemacs/leader-keys org-mode-map
    "m" '(:ignore t :wk "Org")
  ;;   "m a" '(org-agenda :wk "Org agenda")
  ;;   "m e" '(org-export-dispatch :wk "Org export dispatch")
  ;;   "m i" '(org-toggle-item :wk "Org toggle item")
  ;;   "m t" '(org-todo :wk "Org todo")
  ;;   "m B" '(org-babel-tangle :wk "Org babel tangle")
  ;;   "m T" '(org-todo-list :wk "Org todo list")
  ;;   "m b" '(:ignore t :wk "Tables")
  ;;   "m b -" '(org-table-insert-hline :wk "Insert hline in table")
  ;;   "m d" '(:ignore t :wk "Date/deadline")
  ;;   "m d t" '(org-time-stamp :wk "Org time stamp")
    )

  ;; (nemacs/leader-keys
  ;;   "p" '(projectile-command-map :wk "Projectile"))

  (nemacs/leader-keys
    "s" '(:ignore t :wk "Spelling")
  ;;   "s b" '(flyspell-buffer :wk "Check buffer")
  ;;   "s d" '(nemacs/fd-switch-dictionary t :wk "Change dictionary")
  ;; "s n" '(flyspell-goto-next-error :wk "Go to next error")
  ;; "s p" '(flycheck-popup-auto-correct-mode :wk "Toggle popup")
  ;;   "s r" '(flyspell-region :wk "Check region")
  ;;   "s s" '(flyspell-correct-at-point :wk "Correct at point")
  ;;   "s t" '(nemacs/flyspell-toggle t :wk "Toggle spell check")
    )

  (nemacs/leader-keys
    "T" '(:ignore t :wk "Theme")
    "T l" '(load-theme :wk "Load theme")
    ;;  "T n" '((lambda () (interactive) (load-theme 'doom-one t)) :wk "Load night theme")
    ;;  "T d" '((lambda () (interactive) (load-theme 'doom-one-light t)) :wk "Toggle day theme")
    )

  (nemacs/leader-keys
    "t" '(:ignore t :wk "Toggle")
    ;; "t e" '(eshell-toggle :wk "Toggle eshell")
    ;; "t e" '(flycheck-list-errors :wk "Toggle errors list")
    ;;"t e" '(lsp-treemacs-errors-list :wk "Toggle errors list")
    "t L" '(display-fill-column-indicator-mode :wk "Toggle long lines visual limit")
    "t l" '(display-line-numbers-mode :wk "Toggle line numbers")
    ;; "t n" '(neotree-toggle :wk "Toggle neotree file viewer")
    ;; "t s" '(nemacs/flyspell-toggle t :wk "Toggle spell check")
    "t t" '(visual-line-mode :wk "Toggle truncated lines")
    ;; "t z" '(vterm-toggle :wk "Toggle zsh")
    ;; "t z" '(eshell-toggle :wk "Toggle eshell")
    )

  ;; (nemacs/leader-keys
  ;;   "w" '(:ignore t :wk "Windows")
  ;;   "w <left>" '(buf-move-left :wk "Buffer move left")
  ;;   "w <down>" '(buf-move-down :wk "Buffer move down")
  ;;   "w <up>" '(buf-move-up :wk "Buffer move up")
  ;;   "w <right>" '(buf-move-right :wk "Buffer move right"))
  ;; )
  )
#+end_src

And a few keybindings that doesn't belong to any groups

#+begin_src emacs-lisp
(general-define-key
  ;; "C-M-j" '(counsel-switch-buffer :wk "Better file buffer")
 "C-x <down>" '(bs-show :wk "BS show")
 "C-=" '(text-scale-increase :wk "Zoom in")
 "<C-wheel-down>" '(text-scale-increase :wk "Zoom in")
 "C--" '(text-scale-decrease :wk "Zoom out")
 "<C-wheel-up>" '(text-scale-decrease  :wk "Zoom out")
 ;; "C-x 1" '(nemacs/toggle-maximize-buffer :wk "Maximize")

 ;; ctrl+pgup / ctrl+pgdn to change next/prev tab
 ;; "<C-next>" '(tab-bar-switch-to-next-tab :wk "Next tab")
 ;; "<C-prior>" '(tab-bar-switch-to-prev-tab :wk "Previous tab")
 )

;; pres ESC once instead of twice of three times
(global-set-key [escape] 'keyboard-escape-quit)
#+end_src

**** helpful

For contextual information

#+BEGIN_SRC emacs-lisp
;; install an enriched help screen
(use-package helpful
  :ensure(:wait t)
  :demand t
  ;; :custom   ;; set some custom-var
  ;; (counsel-describe-function-function #'helpful-callable)
  ;; (counsel-describe-variable-function #'helpful-variable)
  :bind

  ;; (global-set-key (kbd "C-h f") #'helpful-callable)
  ;; (global-set-key (kbd "C-h v") #'helpful-variable)
  ;; (global-set-key (kbd "C-h k") #'helpful-key)
  ;; (global-set-key (kbd "C-h x") #'helpful-command)

  ([remap describe-function] . helpful-callable)
  ([remap describe-command] . helpful-command)
  ([remap describe-variable] . helpful-variable)
  ([remap describe-key] . helpful-key))
#+END_SRC

**** which-key

Which key for helpful emacs

#+BEGIN_SRC emacs-lisp
;; install which-key
(use-package which-key
  :ensure(:wait t)
  :demand t
  :init
  (setq which-key-enable-extended-define-key t)
  (which-key-mode 1) ;;; init is run every time at pre-config aka set var, invoke mode
  :diminish
  :config                ;;; config is run after the mode' loaded (via hook ?)
  (setq which-key-side-window-location 'bottom
        which-key-sort-order #'which-key-key-order
        which-key-allow-imprecise-window-fit nil
        which-key-sort-uppercase-first nil
        which-key-add-column-padding 1
        which-key-max-display-columns nil
        which-key-min-display-lines 6
        which-key-side-window-slot -10
        which-key-side-window-max-height 0.25
        which-key-idle-delay 0.3
        which-key-max-description-length 25
        which-key-allow-imprecise-window-fit nil
        which-key-separator " → " ))

;; document un-documented commonnly used shortcuts
(which-key-add-key-based-replacements
  "C-x t" "Tabs mgmt")
#+END_SRC

*** TODO completion

**** TODO ivy

*** TODO UI

**** landing dashboard

***** dad jokes ?

Stolen from [[https://howardabrams.com/hamacs/ha-dashboard.html][here]] - I like the idea :nerd_face:.

#+begin_src emacs-lisp
(use-package request
  :ensure(:wait t)
  :demand t
  :init
  (defvar nemacs-dad-joke nil "Holds the latest dad joke.")

  :config
  (defun nemacs-dad-joke ()
    "Display a random dad joke."
    (interactive)
    (message (nemacs--dad-joke)))

  (defun nemacs--dad-joke ()
    "Return string containing a dad joke from www.icanhazdadjoke.com."
    (setq nemacs-dad-joke nil)  ; Clear out old joke
    (nemacs--dad-joke-request)
    (nemacs--dad-joke-wait))

  (defun nemacs--dad-joke-wait ()
    (while (not nemacs-dad-joke)
      (sit-for 1))
    (unless nemacs-dad-joke
      (nemacs--dad-joke-wait))
    nemacs-dad-joke)

  (defun nemacs--dad-joke-request ()
    (request "https://icanhazdadjoke.com"
      :sync t
      :complete (cl-function
                 (lambda (&key data &allow-other-keys)
                   (setq nemacs-dad-joke data))))))


#+end_src

***** emacs features

I would appreciate seeing if my Emacs installation has the features that I expect:

#+begin_src emacs-lisp
(defun nemacs-features (&optional non-iconic)
  "Simple display of features I'm most keen about.
  If NON-ICONIC is non-nil, return a string of text only."
  (interactive)

  (defun feature-combo (container icon title)
    (font-icons container icon :title title :height 1.3 :v-adjust -0.1))

  (defun all-images ()
    (s-join "·"
            (-remove 'null
                     (list
                      (when (image-type-available-p 'gif)  "GIF")
                      (when (image-type-available-p 'svg)  "SVG")
                      (when (image-type-available-p 'jpeg) "JPG")
                      (when (image-type-available-p 'tiff) "TIFF")
                      (when (image-type-available-p 'webp) "WEBP")
                      (when (image-type-available-p 'png)  "PNG")))))

  (let* ((features
          (list
           ;; An either or ... at least for me:
           (when (eq (window-system) 'ns)
             (feature-combo  'faicon "apple"   "MacOS"))
           (when (eq (window-system) 'pgtk)
             (feature-combo  'faicon "xing"    "Gnome"))

           ;; Important to know if I have it:
           (when (and (fboundp 'native-comp-available-p)
                      (native-comp-available-p))
             (feature-combo  'faicon "cog"     "Native Compilation"))
           (when (treesit-available-p)
             (feature-combo  'faicon "tree"    "Tree Sitter"))
           (when (sqlite-available-p)
             (feature-combo  'faicon "database" "Sqlite"))
           (when (gnutls-available-p)
             (feature-combo  'faicon "expeditedssl" "TLS"))
           ;; Did we build with mail utilities? Check the command line
           ;; options we used to build Emacs:
           (when (or (string-search "with-mailutils" system-configuration-options)
                     (string-search "without-pop" system-configuration-options))
             (feature-combo  'octicon "mail" "GNU Mail"))

           (when (fboundp 'make-xwidget)
             (feature-combo  'mdicon "widgets" "XWidgets"))

           ;; This suffix of loadable module files will be nil if
           ;; modules are not supported:
           (when module-file-suffix  ; or (fboundp 'module-load)
             (feature-combo 'faicon "th"       "Modules"))

           (when (json-available-p)
             (feature-combo  'codicon "json"   "JSON"))
           (when (string-search "HARFBUZZ" system-configuration-features)
             (feature-combo  'faicon "font"    "HARFBUZZ"))
           (when (string-search "DBUS" system-configuration-features)
             (feature-combo  'faicon "bus"     "DBUS"))
           (feature-combo  'faicon "picture-o" (all-images))
           (when (fboundp 'imagemagick-types)
             (feature-combo  'faicon "magic"   "ImageMagick"))))
         (results (s-join "  " (-remove 'null features))))

    (if (called-interactively-p)
        (message "Enabled features: %s" results)
      results)))
#+end_src

***** dashboard

Nice welcome screen. See the official
[[https://github.com/emacs-dashboard/emacs-dashboard][repo]] for more info.

#+BEGIN_SRC emacs-lisp
(use-package page-break-lines
  :ensure(:wait t)
  :demand t
)

;; nicer welcome screen
(use-package dashboard
  :ensure(:wait t)
  :demand t
  :after (all-the-icons projectile page-break-lines)
  :init      ; tweak dashboard config before loading it
  (setq initial-buffer-choice 'dashboard-refresh-buffer)
  (setq dashboard-projects-backend 'projectile)


  ;; horizontally center content
  (setq dashboard-center-content t)
  ;; verically center content
  (setq dashboard-vertically-center-content t)
  ;; enable cycle navigation between each section
  (setq dashboard-navigation-cycle t)

  ;; add icons to the widget headings and their items
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)

  (setq dashboard-set-navigator t)
  ; close agenda buffers
  (setq dashboard-agenda-release-buffers t)
  (setq dashboard-set-init-info t) ; package & loadtime

  ;; (setq dashboard-display-icons-p t) ;; use `all-the-icons' package
  ;; (setq dashboard-icon-type 'nerd-icons) ;; use `all-the-icons' package
  (setq dashboard-icon-type 'all-the-icons) ;; use `all-the-icons' package

  (setq dashboard-projects-switch-function 'counsel-projectile-switch-project-by-name)

  (setq dashboard-banner-logo-title "Emacs Is More Than A Text Editor!")
  (setq dashboard-startup-banner "/home/master/repo/perso/nemacs/logo/aum.xpm")
  (setq dashboard-image-banner-max-width 500)
  (setq dashboard-image-banner-max-height 500)
  (setq dashboard-image-extra-props '(:mask heuristic))


  (setq dashboard-items '((agenda . 15)
                          (recents . 15)
                          (projects . 15)
                          ;; (bookmarks . 5)
                          ;; (registers . 5)
                          ))

  (setq dashboard-item-shortcuts '((recents   . "r")
                                 (bookmarks . "m")
                                 (projects  . "p")
                                 (agenda    . "a")
                                 (registers . "e")
                                 ))

  (setq dashboard-item-names '(("Recent Files:"               . "Recently opened files:")
                               ("Agenda for today:"           . "Today's agenda:")
                               ("Agenda for the coming week:" . "Agenda:")
                               ))

  :when (not command-line-args-left)
  :config
  (dashboard-setup-startup-hook)
  (dashboard-modify-heading-icons '((recents . "file-text"))


                                  ;; Format: "(icon title help action face prefix suffix)"

)
)

#+END_SRC


**** faces

#+BEGIN_SRC emacs-lisp
;; Set the default face
(set-face-attribute 'default nil
                    :font "Fira Code Retina"
                    :height 120)

;; Set the fixed pitch face
(set-face-attribute 'fixed-pitch nil
                    :font "Fira Code Retina"
                    :height 100)

;; Set the variable pitch face
(set-face-attribute 'variable-pitch nil
                    :font "Fira Code Retina"
                    :height 295 :weight 'regular)
#+END_SRC

***** all-the-icons / dired

Seems [[https://github.com/rainstormstudio/nerd-icons.el][nerd icons]] may be a nice alternative.

#+BEGIN_SRC emacs-lisp
;; Please run M-x all-the-icons-install-fonts
(use-package all-the-icons
  :ensure(:wait t)
  :demand t
  :if (display-graphic-p))

;; (use-package dired-single) --> not found starting 30.0 ?

(use-package all-the-icons-dired
  :ensure(:wait t)
  :demand t
  :hook (dired-mode . (lambda () (all-the-icons-dired-mode t))))

(use-package all-the-icons-completion
  :ensure(:wait t)
  :demand t
  :after (all-the-icons)
  :init (all-the-icons-completion-mode))

(use-package dired-open
  :ensure(:wait t)
  :demand t
  :config
  ;; Doesn't work as expected!
  ;;(add-to-list 'dired-open-functions #'dired-open-xdg t)
  (setq dired-open-extensions '(("png" . "feh")
                                ("mkv" . "mpv"))))

(use-package dired-hide-dotfiles
  :ensure(:wait t)
  :demand t
  :hook (dired-mode . dired-hide-dotfiles-mode))
#+END_SRC

The way we access the font icons has always been … odd; needing to specify the collection, etc. I would like to come up with a better mechanism, so the following function abstracts that as I figure out a better solution.

#+begin_src emacs-lisp
(defun font-icons (collection label &rest args)
  "Abstraction over `all-the-icons' project.
LABEL is the icon name as used by all-the-icons.
COLLECTION identifies the icon set (e.g. 'octicon, 'faicon).

ARGS is a plist passed directly to the all-the-icons function.

Example:
  (font-icons 'octicon \"git-branch\" :title \"Git\")

Reformats:
  (all-the-icons-octicon \"git-branch\")
into:
  (font-icons 'octicon \"git-branch\")"
  (let* ((func (intern (format "all-the-icons-%s" collection)))
         (title (plist-get args :title))
         (space (plist-get args :space))
         ;; remove our custom keys before passing args through
         (icon-args (cl-loop for (k v) on args by #'cddr
                             unless (memq k '(:title :space))
                             append (list k v))))
    (concat
     (apply func label icon-args)
     (cond
      ((and title space) (concat (s-repeat space " ") title))
      (title             (concat " " title))))))
#+end_src

***** ligature

emacs 27+ "nativly" support ligature. See the
[[https://github.com/mickeynp/ligature.el/wiki#cascadia--fira-code][official doc]] for more info.

#+BEGIN_SRC emacs-lisp
;;;;;;;;;;;;;;;;;;;;;;
;; Ligature support ;;
;;;;;;;;;;;;;;;;;;;;;;

(use-package ligature
  :ensure(:wait t)
  :demand t
  :config
  ;; Enable the "www" ligature in every possible major mode
  (ligature-set-ligatures 't '("www"))
  ;; Enable traditional ligature support in eww-mode, if the
  ;; `variable-pitch' face supports it
  (ligature-set-ligatures 'eww-mode '("ff" "fi" "ffi"))
  ;; Enable all Cascadia and Fira Code ligatures in programming modes
  (ligature-set-ligatures 'prog-mode
                          '(;; == === ==== => =| =>>=>=|=>==>> ==< =/=//=// =~
                            ;; =:= =!=
                            ("=" (rx (+ (or ">" "<" "|" "/" "~" ":" "!" "="))))
                            ;; ;; ;;;
                            (";" (rx (+ ";")))
                            ;; && &&&
                            ("&" (rx (+ "&")))
                            ;; !! !!! !. !: !!. != !== !~
                            ("!" (rx (+ (or "=" "!" "\." ":" "~"))))
                            ;; ?? ??? ?:  ?=  ?.
                            ("?" (rx (or ":" "=" "\." (+ "?"))))
                            ;; %% %%%
                            ("%" (rx (+ "%")))
                            ;; |> ||> |||> ||||> |] |} || ||| |-> ||-||
                            ;; |->>-||-<<-| |- |== ||=||
                            ;; |==>>==<<==<=>==//==/=!==:===>
                            ("|" (rx (+ (or ">" "<" "|" "/" ":" "!" "}" "\]"
                                            "-" "=" ))))
                            ;; \\ \\\ \/
                            ("\\" (rx (or "/" (+ "\\"))))
                            ;; ++ +++ ++++ +>
                            ("+" (rx (or ">" (+ "+"))))
                            ;; :: ::: :::: :> :< := :// ::=
                            (":" (rx (or ">" "<" "=" "//" ":=" (+ ":"))))
                            ;; // /// //// /\ /* /> /===:===!=//===>>==>==/
                            ("/" (rx (+ (or ">"  "<" "|" "/" "\\" "\*" ":" "!"
                                            "="))))
                            ;; .. ... .... .= .- .? ..= ..<
                            ("\." (rx (or "=" "-" "\?" "\.=" "\.<" (+ "\."))))
                            ;; -- --- ---- -~ -> ->> -| -|->-->>->--<<-|
                            ("-" (rx (+ (or ">" "<" "|" "~" "-"))))
                            ;; *> */ *)  ** *** ****
                            ("*" (rx (or ">" "/" ")" (+ "*"))))
                            ;; www wwww
                            ("w" (rx (+ "w")))
                            ;; <> <!-- <|> <: <~ <~> <~~ <+ <* <$ </  <+> <*>
                            ;; <$> </> <|  <||  <||| <|||| <- <-| <-<<-|-> <->>
                            ;; <<-> <= <=> <<==<<==>=|=>==/==//=!==:=>
                            ;; << <<< <<<<
                            ("<" (rx (+ (or "\+" "\*" "\$" "<" ">" ":" "~"  "!"
                                            "-"  "/" "|" "="))))
                            ;; >: >- >>- >--|-> >>-|-> >= >== >>== >=|=:=>>
                            ;; >> >>> >>>>
                            (">" (rx (+ (or ">" "<" "|" "/" ":" "=" "-"))))
                            ;; #: #= #! #( #? #[ #{ #_ #_( ## ### #####
                            ("#" (rx (or ":" "=" "!" "(" "\?" "\[" "{" "_(" "_"
                                         (+ "#"))))
                            ;; ~~ ~~~ ~=  ~-  ~@ ~> ~~>
                            ("~" (rx (or ">" "=" "-" "@" "~>" (+ "~"))))
                            ;; __ ___ ____ _|_ __|____|_
                            ("_" (rx (+ (or "_" "|"))))
                            ;; Fira code: 0xFF 0x12
                            ("0" (rx (and "x" (+ (in "A-F" "a-f" "0-9")))))
                            ;; Fira code:
                            "Fl"  "Tl"  "fi"  "fj"  "fl"  "ft"
                            ;; The few not covered by the regexps.
                            "{|"  "[|"  "]#"  "(*"  "}#"  "$>"  "^="))
  ;; Enables ligature checks globally in all buffers. You can also do it
  ;; per mode with `ligature-mode'.
  (global-ligature-mode t)
  )
#+END_SRC

**** doom

#+BEGIN_SRC emacs-lisp
(use-package doom-modeline
  ;; :ensure(:wait t)
  ;; :demand t
  :defer 2
  ;; :init (doom-modeline-mode 1)
  :config
  (column-number-mode 1)
  (doom-modeline-mode 1)
  (display-battery-mode)
  :custom
  (doom-modeline-project-detection 'projectile "Use projectile to fetch the project")
  (doom-modeline-time-icon nil "Disable time")
  (doom-modeline-enable-word-count t "Enable word count")
  ;; (setq doom-modeline-vcs-max-length 12)
                                        ; (doom-modeline-minor-modes t "Enable minor mode display")
  )

;; install nicer theme
;; need to run M-x nerd-icons-install-fonts
(use-package doom-themes
  :ensure(:wait t)
  :demand t
  :config
  ;; Global settings (defaults)
  (setq
   ;; if nil, bold is universally disabled
   doom-themes-enable-bold t
   ;; if nil, italics is universally disabled
   doom-themes-enable-italic t)

  (load-theme 'doom-one t)

  ;; Enable flashing mode-line on errors
  (doom-themes-visual-bell-config)
  ;; Enable custom neotree theme (all-the-icons must be installed!)
  ;; (doom-themes-neotree-config)
  ;; or for treemacs users
  (setq doom-themes-treemacs-theme "doom-atom") ; use "doom-colors" for less minimal icon theme
  ;; (doom-themes-treemacs-config)
  ;; Corrects (and improves) org-mode's native fontification.
  (doom-themes-org-config))
#+END_SRC

**** diminish

This package implements hiding or abbreviation of the modeline displays
(lighters) of minor-modes.  With this package installed, you can add
':diminish' to any use-package block to hide that particular mode in the
modeline.

#+BEGIN_SRC emacs-lisp
(use-package diminish
  :ensure(:wait t)
  :demand t
  :config
  (diminish 'whitespace-mode)
  (diminish 'eldoc-mode)
  (diminish 'abbrev-mode)
  (diminish 'auto-revert-mode)
)
#+END_SRC


**** TODO tabs
**** TODO transparency
**** TODO clean up
**** TODO line/col
**** TODO buffers

*** TODO QoL

**** install boosted string manipulation functions

The [[https://github.com/magnars/s.el][s.el]] project is a simpler string manipulation library that I (and other projects) use.

Manipulate file paths with the [[https://github.com/rejeep/f.el][f.el]] project.

#+begin_src emacs-lisp
(use-package s)
(use-package f)
#+end_src

*** IDE

**** projectile

#+BEGIN_SRC emacs-lisp
;; projects handler
(use-package projectile
  :ensure(:wait t)
  :demand t
  :after (general)
  :diminish
  :config (add-to-list 'projectile-globally-ignored-directories "*node_modules")
  (add-to-list 'projectile-globally-ignored-directories "*vendor")
  (projectile-mode 1)
  ;; :custom ((project-completion-system 'ivy))
  :init
  (when (file-directory-p "~/repo")
    (setq projectile-project-search-path '("~/repo")))
  (setq
   projectile-indexing-method 'alien
   projectile-enable-caching t
   projectile-switch-project-action #'projectile-dired))

(projectile-register-project-type 'go_make '("Makefile" "src" "etc")
                                  ;; :project-file '("Makefile", "src/go.mod" "src/go.sum", "src/vendor")
                                  ;; :compilation-dir "."
                                  :compile "make static"
                                  :configure "make tidy sync rvendor"
                                  ;; :install "make install DESTDIR=`mktemp -d`"
                                  :test "make test TEST_ARGS='-failfast' TEST_TIMEOUT=5s"
                                  :src-dir "src"
                                  :test-suffix "_test.go")

#+END_SRC

**** TODO LSP
